rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================

    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * Check if request is from a valid source
     * TODO: Tighten this in production with API key validation
     */
    function isValidRequest() {
      return true;  // Permissive for development
    }


    // ============================================================================
    // WARDS COLLECTION
    // ============================================================================

    match /wards/{wardId} {

      // Ward configuration - Read only (public)
      // Writes must go through Cloud Functions for validation
      allow read: if isValidRequest();
      allow write: if false;  // Only Cloud Functions can write

      // ------------------------------------------------------------
      // STATS SUBCOLLECTION
      // ------------------------------------------------------------
      match /stats/{statsDoc} {
        // Stats are public read-only
        // Only Cloud Functions can update (transactional)
        allow read: if isValidRequest();
        allow write: if false;
      }

      // ------------------------------------------------------------
      // TEMPLE SQUARES SUBCOLLECTION
      // ------------------------------------------------------------
      match /templeSquares/{squareNumber} {
        // Squares are public read-only
        // Only Cloud Functions can claim squares (transactional)
        allow read: if isValidRequest();
        allow write: if false;
      }

      // ------------------------------------------------------------
      // VISITS SUBCOLLECTION
      // ------------------------------------------------------------
      match /visits/{visitId} {
        // Visits are public read-only (for audit log)
        // Only Cloud Functions can create visits (transactional)
        allow read: if isValidRequest();
        allow write: if false;
      }

      // ------------------------------------------------------------
      // SELFIES SUBCOLLECTION
      // ------------------------------------------------------------
      match /selfies/{selfieId} {
        // Selfies are public read-only
        // Only Cloud Functions can create selfie records (via Storage trigger)
        allow read: if isValidRequest();
        allow write: if false;
      }
    }


    // ============================================================================
    // DEFAULT DENY
    // ============================================================================

    // Deny all other reads/writes
    match /{document=**} {
      allow read, write: if false;
    }
  }
}


// ============================================================================
// PRODUCTION SECURITY NOTES
// ============================================================================
//
// This ruleset is permissive for development. Before going to production:
//
// 1. AUTHENTICATION:
//    - Implement Firebase Auth or API key validation
//    - Replace isValidRequest() with proper auth checks
//
// 2. RATE LIMITING:
//    - Add App Check to prevent abuse
//    - Consider Cloud Functions rate limiting
//
// 3. FIELD VALIDATION:
//    - Validate data types and ranges in Cloud Functions
//    - Add server-side input sanitization
//
// 4. READ RESTRICTIONS (Optional):
//    - If ward data should be private, add authentication
//    - Current ruleset allows public reads (for kiosk displays)
//
// 5. WRITE PATH:
//    - All writes MUST go through Cloud Functions
//    - Direct client writes are blocked (allow write: if false)
//    - This ensures data integrity and transactional safety
//
// ============================================================================
