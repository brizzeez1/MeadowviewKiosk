rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================

    /**
     * Check if request is from a valid source
     * TODO: Tighten this in production with API key validation or App Check
     */
    function isValidRequest() {
      return true;  // Permissive for development
    }


    // ============================================================================
    // WARDS COLLECTION (Ward Configuration)
    // ============================================================================

    match /wards/{wardId} {
      // Ward configuration - Read allowed for PWA/Kiosk (source of truth)
      // Client writes denied (Cloud Functions only)
      allow read: if isValidRequest();
      allow write: if false;  // Only Cloud Functions can write

      // Stats subcollection
      match /stats/{statsId} {
        allow read: if isValidRequest();
        allow write: if false;  // Only Cloud Functions can write
      }

      // Temple Squares subcollection
      match /templeSquares/{squareId} {
        allow read: if isValidRequest();
        allow write: if false;  // Only Cloud Functions can write
      }

      // Visits subcollection
      match /visits/{visitId} {
        allow read: if isValidRequest();
        allow write: if false;  // Only Cloud Functions can write
      }

      // Selfies subcollection (Phase 6)
      match /selfies/{selfieId} {
        allow read: if isValidRequest();
        allow write: if false;  // Only Cloud Functions/Storage triggers can write
      }

      // Missionaries subcollection (Phase 7)
      match /missionaries/{missionaryId} {
        // Missionaries are public read-only for Kiosk
        // Only Cloud Functions/admin can write
        allow read: if isValidRequest();
        allow write: if false;  // Only Cloud Functions can write

        // Missionary gallery photos subcollection
        match /gallery/{photoId} {
          allow read: if isValidRequest();
          allow write: if false;  // Only Cloud Functions/storage triggers can write
        }
      }
    }


    // ============================================================================
    // DEFAULT DENY
    // ============================================================================

    // Deny all other reads/writes
    // All data is stored under wards/{wardId}/ subcollections (ARCHITECTURE FIX)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}


// ============================================================================
// ARCHITECTURE NOTES
// ============================================================================
//
// CLIENT READS:
// - PWA and kiosk read directly using Firestore client SDK
// - Real-time sync via onSnapshot listeners
// - Collections: wards/{wardId}, wardStats/{wardId}, templeSquares/{wardId}/squares/*
//
// CLIENT WRITES:
// - All client writes are BLOCKED (allow write: if false)
// - Mutations only via Cloud Functions API:
//   - POST /api/v1/temple/logVisit
//   - POST /api/v1/temple/logBonusVisit
//
// CLOUD FUNCTIONS:
// - Use Admin SDK (bypasses security rules)
// - Transactions for atomic updates (stats, squares, visits)
// - No REST GET endpoints (clients read directly from Firestore)
//
// PRODUCTION HARDENING:
// 1. Replace isValidRequest() with App Check or API key validation
// 2. Add rate limiting via Cloud Functions
// 3. Consider restricting templeVisits reads if audit log should be private
// 4. Enable Firebase Authentication if user-specific access is needed
//
// ============================================================================
