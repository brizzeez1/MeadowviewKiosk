rules_version = '2';

/**
 * Firebase Storage Security Rules - Temple 365, Selfie Mosaic, Missionary Uploads
 *
 * Phase 6: Selfie-Only Upload Pipeline
 * Phase 8: Missionary Photo/Video Upload Portal
 *
 * IMPORTANT:
 * - Signed URL uploads don't require authentication
 * - Cloud Function controls who gets signed URLs (rate limiting, validation)
 * - Uploads restricted to specific path patterns
 *
 * Deploy: firebase deploy --only storage
 */

service firebase.storage {
  match /b/{bucket}/o {

    // ========================================================================
    // WARD SELFIES (Phase 6)
    // ========================================================================
    // Path: wards/{wardId}/selfies/{fileName}
    //
    // Write access: Via signed URLs only (15-minute expiration)
    // Read access: Public (for mosaic display)
    //
    match /wards/{wardId}/selfies/{fileName} {
      // Allow signed URL uploads (request.auth is null for signed URLs)
      allow write: if request.auth == null
                   && request.resource.contentType.matches('image/.*')
                   && request.resource.size < 10 * 1024 * 1024;  // Max 10MB

      // Allow public read for mosaic display
      allow read: if true;
    }

    // ========================================================================
    // TEMPLE 365 VISIT SELFIES (Future - Phase 7+)
    // ========================================================================
    // When visits can include selfies, they'll be stored here
    //
    match /wards/{wardId}/visit-selfies/{fileName} {
      // Same rules as above
      allow write: if request.auth == null
                   && request.resource.contentType.matches('image/.*')
                   && request.resource.size < 10 * 1024 * 1024;
      allow read: if true;
    }

    // ========================================================================
    // MISSIONARY GALLERY UPLOADS (Phase 8)
    // ========================================================================
    // Path: wards/{wardId}/missionaries/gallery/{missionaryId}/{fileName}
    //
    // Write access: Via signed URLs only (family/friend uploads with token)
    // Read access: Public (for kiosk gallery display)
    //
    match /wards/{wardId}/missionaries/gallery/{missionaryId}/{fileName} {
      // Allow signed URL uploads (request.auth is null for signed URLs)
      // Support both photos and videos
      allow write: if request.auth == null
                   && (request.resource.contentType.matches('image/.*')
                       || request.resource.contentType.matches('video/.*'))
                   && request.resource.size < 100 * 1024 * 1024;  // Max 100MB (spec decision #10)

      // Allow public read for kiosk gallery display
      allow read: if true;
    }

    // ========================================================================
    // MISSIONARY PROFILE PHOTOS (Phase 7)
    // ========================================================================
    // Path: wards/{wardId}/missionaries/photos/{fileName}
    //
    // Admin-only writes (via seed scripts)
    // Public reads (for kiosk display)
    //
    match /wards/{wardId}/missionaries/photos/{fileName} {
      allow write: if false;  // Admin SDK only
      allow read: if true;
    }

    // ========================================================================
    // MISSIONARY KIOSK VIDEO MESSAGES (Phase 9)
    // ========================================================================
    // Path: wards/{wardId}/missionaries/videos/{missionaryId}/{fileName}
    //
    // Write access: Via signed URLs only (kiosk recordings)
    // Read access: Public (for kiosk gallery display)
    //
    // Kiosk videos are capped at 30 seconds (locked decision #11)
    // Expected file size: 5-15MB at 2.5 Mbps bitrate
    //
    match /wards/{wardId}/missionaries/videos/{missionaryId}/{fileName} {
      // Allow signed URL uploads (request.auth is null for signed URLs)
      allow write: if request.auth == null
                   && request.resource.contentType.matches('video/.*')
                   && request.resource.size < 50 * 1024 * 1024;  // Max 50MB (safety margin for 30-sec videos)

      // Allow public read for kiosk gallery display
      allow read: if true;
    }

    // ========================================================================
    // DENY ALL OTHER ACCESS
    // ========================================================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
