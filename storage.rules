rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ============================================================================
    // WARDS STORAGE - SELFIE UPLOADS
    // ============================================================================

    match /wards/{wardId}/selfies/{fileName} {

      // Allow public read for all selfies (for kiosk display)
      allow read: if true;

      // Allow write only via signed URLs from Cloud Functions
      // Direct client uploads are blocked
      allow write: if false;
    }

    // ============================================================================
    // WARDS STORAGE - MISSIONARY PHOTOS
    // ============================================================================

    match /wards/{wardId}/missionaries/{fileName} {

      // Allow public read for missionary photos
      allow read: if true;

      // Allow write only via upload portal with valid token
      // Direct uploads blocked - must use Cloud Function signed URL
      allow write: if false;
    }

    // ============================================================================
    // WARDS STORAGE - MISSIONARY VIDEOS
    // ============================================================================

    match /wards/{wardId}/missionary-videos/{fileName} {

      // Allow public read for missionary videos
      allow read: if true;

      // Allow write only via Cloud Function signed URL
      allow write: if false;
    }

    // ============================================================================
    // DEFAULT DENY
    // ============================================================================

    // Deny all other storage access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}


// ============================================================================
// UPLOAD FLOW
// ============================================================================
//
// All uploads use signed URLs generated by Cloud Functions:
//
// 1. Client calls Cloud Function API (e.g., /api/v1/mosaic/requestSelfieUpload)
// 2. Cloud Function validates request and generates signed URL
// 3. Client uploads directly to Cloud Storage using signed URL
// 4. Storage trigger creates Firestore record
//
// This approach:
// - Prevents direct client writes (security)
// - Allows uploads without authentication (ease of use)
// - Enforces upload quotas and validation (Cloud Functions)
// - Enables post-processing (Storage triggers)
//
// ============================================================================
